<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body { background: #0b1220; color: #eef2ff; }
    .results-page { position: relative; min-height: 100vh; }
    
    /* Feedback Section Styles */
    .feedback-section {
      margin: 24px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .feedback-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .feedback-header h3 {
      color: #2c3e50;
      margin-bottom: 6px;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    .feedback-header p {
      color: #566573;
      font-size: 0.9em;
      margin: 0;
    }
    
    .feedback-form {
      max-width: 450px;
      margin: 0 auto;
    }
    
    .rating-section {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .rating-section label {
      display: block;
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .star-rating {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .star {
      font-size: 1.8em;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.3;
    }
    
    .star:hover {
      transform: scale(1.2);
    }
    
    .rating-text {
      font-size: 0.85em;
      color: #566573;
      height: 16px;
    }
    
    .checkbox-section {
      margin-bottom: 20px;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #3498db;
    }
    
    .checkbox-item label {
      color: #2c3e50;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .comment-section {
      margin-bottom: 20px;
    }
    
    .comment-section label {
      display: block;
      color: #2c3e50;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .comment-section textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      background: #ffffff;
      color: #2c3e50;
      font-family: inherit;
      font-size: 0.9em;
      resize: vertical;
      box-sizing: border-box;
    }
    
    .comment-section textarea::placeholder {
      color: #7f8c8d;
    }
    
    .comment-section textarea:focus {
      outline: none;
      border-color: #3498db;
      background: #ffffff;
    }
    
    .feedback-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .feedback-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }
    
    .feedback-btn.primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }
    
    .feedback-btn.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #2980b9, #1f5f8b);
      transform: translateY(-1px);
    }
    
    .feedback-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #eef2ff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .feedback-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .feedback-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .feedback-status {
      text-align: center;
      font-size: 0.9em;
      padding: 8px;
      border-radius: 6px;
    }
    
    .feedback-status.success {
      color: #27ae60;
      background: rgba(39, 174, 96, 0.1);
    }
    
    .feedback-status.error {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
    
    .feedback-status.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="results-page">
    <div id="resultsRoot"></div>
  </div>

  <script>
    function launchConfetti(duration = 2500) {
      const canvas = document.getElementById('confettiCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const rect = document.body.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      const colors = ['#ff6b6b','#feca57','#1dd1a1','#54a0ff','#5f27cd'];
      const particles = Array.from({ length: 160 }, () => ({
        x: Math.random()*canvas.width,
        y: -20 - Math.random()*100,
        vx: (Math.random()-0.5)*2,
        vy: 2 + Math.random()*3,
        size: 2 + Math.random()*4,
        rot: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.2,
        color: colors[Math.floor(Math.random()*colors.length)]
      }));
      let start = null;
      function frame(ts) {
        if (!start) start = ts;
        const elapsed = ts - start;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if (p.y > canvas.height + 20) { p.y = -20; p.x = Math.random()*canvas.width; }
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
          ctx.fillStyle = p.color; ctx.fillRect(-p.size, -p.size/2, p.size*2, p.size);
          ctx.restore();
        });
        if (elapsed < duration) requestAnimationFrame(frame);
        else { let alpha = 1; const fade = () => { alpha -= 0.08; ctx.globalAlpha = Math.max(alpha, 0); ctx.clearRect(0,0,canvas.width,canvas.height); if (alpha > 0) requestAnimationFrame(fade); else ctx.globalAlpha = 1; }; requestAnimationFrame(fade); }
      }
      requestAnimationFrame(frame);
    }

    function renderResults() {
      let data = null;
      try { data = JSON.parse(sessionStorage.getItem('cmgResults') || 'null'); } catch (_) {}
      const root = document.getElementById('resultsRoot');
      if (!data || !Array.isArray(data.standings)) {
        root.innerHTML = `
          <div class="winner-overlay" style="position: fixed; inset: 0; overflow-y: auto; padding: 40px 20px;">
            <div class="winner-card" style="max-height: none; margin: 0 auto; background: rgba(255,255,255,0.98);">
              <div class="winner-hero">
                <h1>Results Unavailable</h1>
                <p>Start a game to see standings.</p>
              </div>
              <div class="winner-body">
                <div class="winner-actions">
                  <button class="primary" onclick="window.location.href='game.html'">Play Game</button>
                  <button class="secondary" onclick="window.location.href='index.html'">Back to Home</button>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }
      const winner = data.standings[0];
      const topScore = winner[1];
      const topTies = data.standings.filter(s => s[1] === topScore);
      const winnerTitle = data.wasTiebreaker ? 'Tiebreaker Round Complete' : 'Round Complete';
      const winnerLabel = topTies.length > 1
        ? `<strong>Winners:</strong> ${topTies.map(t => t[0]).join(', ')} (${topScore} pts)`
        : `<strong>Winner:</strong> ${winner[0]} (${winner[1]} pts)`;

      // Create podium (top 3) and remaining departments
      const podium = data.standings.slice(0, 3);
      const remaining = data.standings.slice(3);

      const podiumHTML = `
        <div class="podium">
          ${podium[1] ? `
            <div class="podium-place second">
              <div class="podium-medal">ü•à</div>
              <div class="podium-dept">${podium[1][0]}</div>
              <div class="podium-score">${podium[1][1]} pts</div>
              <div class="podium-rank">2nd</div>
            </div>
          ` : ''}
          <div class="podium-place first">
            <div class="podium-medal">üèÜ</div>
            <div class="podium-dept">${podium[0][0]}</div>
            <div class="podium-score">${podium[0][1]} pts</div>
            <div class="podium-rank">1st</div>
          </div>
          ${podium[2] ? `
            <div class="podium-place third">
              <div class="podium-medal">ü•â</div>
              <div class="podium-dept">${podium[2][0]}</div>
              <div class="podium-score">${podium[2][1]} pts</div>
              <div class="podium-rank">3rd</div>
            </div>
          ` : ''}
        </div>
      `;

      const remainingHTML = remaining.length > 0 ? `
        <div class="remaining-depts">
          <div class="remaining-title">Other Departments</div>
          ${remaining.map((s, i) => `
            <div class="remaining-item">
              <span class="remaining-rank">${i + 4}</span>
              <span class="remaining-name">${s[0]}</span>
              <span class="remaining-score">${s[1]} pts</span>
            </div>
          `).join('')}
        </div>
      ` : '';

      root.innerHTML = `
        <div class="winner-overlay" style="position: fixed; inset: 0; overflow-y: auto; padding: 40px 20px;">
          <div class="winner-card" style="max-height: none; margin: 0 auto; background: rgba(255,255,255,0.98); box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <div class="winner-hero">
              <div class="trophy">üèÜ</div>
              <h1>${winnerTitle}</h1>
              <p>${winnerLabel}</p>
            </div>
            <div class="winner-body">
              <div class="winner-pill"><span class="badge">üèÜ</span> Congratulations, ${winner[0]}!</div>
              ${podiumHTML}
              ${remainingHTML}
              <div class="feedback-section">
                <div class="feedback-header">
                  <h3>üìù Rate This Scenario</h3>
                  <p>Help us improve "${data.scenarioTitle || 'this scenario'}"</p>
                </div>
                <div class="feedback-form">
                  <div class="rating-section">
                    <label>How would you rate this scenario overall?</label>
                    <div class="star-rating">
                      <span class="star" data-rating="1">‚≠ê</span>
                      <span class="star" data-rating="2">‚≠ê</span>
                      <span class="star" data-rating="3">‚≠ê</span>
                      <span class="star" data-rating="4">‚≠ê</span>
                      <span class="star" data-rating="5">‚≠ê</span>
                    </div>
                    <div class="rating-text"></div>
                  </div>
                  
                  <div class="checkbox-section">
                    <div class="checkbox-group">
                      <div class="checkbox-item">
                        <input type="checkbox" id="enjoyed">
                        <label for="enjoyed">I enjoyed this scenario</label>
                      </div>
                      <div class="checkbox-item">
                        <input type="checkbox" id="learned">
                        <label for="learned">I learned something from this scenario</label>
                      </div>
                      <div class="checkbox-item">
                        <input type="checkbox" id="realistic">
                        <label for="realistic">This scenario felt realistic</label>
                      </div>
                      <div class="checkbox-item">
                        <input type="checkbox" id="recommend">
                        <label for="recommend">I would recommend this to colleagues</label>
                      </div>
                    </div>
                  </div>
                  
                  <div class="comment-section">
                    <label for="feedbackComment">Any additional thoughts or suggestions?</label>
                    <textarea id="feedbackComment" placeholder="Share your feedback about this scenario - what worked well, what could be improved, how realistic it felt, etc."></textarea>
                  </div>
                  
                  <div class="feedback-buttons">
                    <button id="submitFeedback" class="feedback-btn primary">Submit Feedback</button>
                    <button id="skipFeedback" class="feedback-btn secondary">Skip</button>
                  </div>
                  <div id="feedbackStatus" class="feedback-status hidden"></div>
                </div>
              </div>
              
              <div class="winner-actions">
                <button class="primary" onclick="window.location.href='game.html'">Play Again</button>
                <button class="secondary" onclick="window.location.href='index.html'">Back to Home</button>
              </div>
            </div>
          </div>
          <canvas id="confettiCanvas" class="confetti-canvas"></canvas>
        </div>`;

      launchConfetti(3000);
    }

    let selectedRating = 0;

    function setupFeedback() {
      // Star rating functionality
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
          selectedRating = parseInt(this.dataset.rating);
          updateStarDisplay();
        });
        star.addEventListener('mouseenter', function() {
          const rating = parseInt(this.dataset.rating);
          highlightStars(rating);
        });
      });
      
      document.querySelector('.star-rating').addEventListener('mouseleave', function() {
        updateStarDisplay();
      });
      
      // Submit feedback
      document.getElementById('submitFeedback').addEventListener('click', submitFeedback);
      document.getElementById('skipFeedback').addEventListener('click', skipFeedback);
    }
    
    function updateStarDisplay() {
      document.querySelectorAll('.star').forEach((star, index) => {
        if (index < selectedRating) {
          star.style.opacity = '1';
          star.style.transform = 'scale(1.1)';
        } else {
          star.style.opacity = '0.3';
          star.style.transform = 'scale(1)';
        }
      });
      
      const ratingText = document.querySelector('.rating-text');
      if (selectedRating > 0) {
        ratingText.textContent = `${selectedRating} out of 5 stars`;
      } else {
        ratingText.textContent = '';
      }
    }
    
    function highlightStars(rating) {
      document.querySelectorAll('.star').forEach((star, index) => {
        if (index < rating) {
          star.style.opacity = '1';
          star.style.transform = 'scale(1.1)';
        } else {
          star.style.opacity = '0.3';
          star.style.transform = 'scale(1)';
        }
      });
    }
    
    function skipFeedback() {
      document.querySelector('.feedback-section').style.display = 'none';
    }
    
    async function submitFeedback() {
      const comment = document.getElementById('feedbackComment').value;
      const enjoyed = document.getElementById('enjoyed').checked;
      const learned = document.getElementById('learned').checked;
      const realistic = document.getElementById('realistic').checked;
      const recommend = document.getElementById('recommend').checked;
      
      const statusEl = document.getElementById('feedbackStatus');
      const submitBtn = document.getElementById('submitFeedback');
      
      if (selectedRating === 0) {
        statusEl.textContent = 'Please select a rating before submitting.';
        statusEl.className = 'feedback-status error';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      try {
        const data = JSON.parse(sessionStorage.getItem('cmgResults') || '{}');
        const feedback = {
          scenarioTitle: data.scenarioTitle || 'Unknown',
          rating: selectedRating,
          enjoyed: enjoyed,
          learned: learned,
          realistic: realistic,
          recommend: recommend,
          comment: comment.trim(),
          timestamp: new Date().toISOString(),
          gameResults: {
            scores: data.scores,
            winner: data.standings?.[0]?.[0] || 'Unknown'
          }
        };
        
        const response = await fetch('/api/submit-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feedback)
        });
        
        if (response.ok) {
          statusEl.textContent = '‚úÖ Thank you for your feedback!';
          statusEl.className = 'feedback-status success';
          document.querySelector('.feedback-form').style.opacity = '0.5';
          submitBtn.style.display = 'none';
          document.getElementById('skipFeedback').textContent = 'Close';
        } else {
          throw new Error('Failed to submit');
        }
      } catch (error) {
        statusEl.textContent = '‚ùå Failed to submit feedback. Please try again.';
        statusEl.className = 'feedback-status error';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Feedback';
      }
    }

    renderResults();
    // Setup feedback after DOM is ready
    setTimeout(setupFeedback, 100);
  </script>
<script src="/js/theme.js"></script>
</body>
</html>
