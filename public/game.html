<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crisis Management Game</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <img src="/images/bank-logo.png" alt="SSBTX Logo">
    <div class="title">
      Crisis Management Game
      <span style="font-size:12px;background:#d3f9d8;color:#2b8a3e;padding:2px 6px;border-radius:6px;margin-left:8px;">
        Live
      </span>
    </div>
  </div>

  <!-- SCOREBOARD (ALWAYS VISIBLE) -->
  <div id="scoreboard" class="scoreboard"></div>

  <!-- SCENARIO -->
  <div class="scenario-box">
    <h2 id="scenarioTitle">Scenario</h2>
    <p id="scenarioText">Loading scenario...</p>
  </div>

  <!-- QUESTION AREA -->
  <div id="questionBox" class="question-box"></div>

  <!-- CONTROLS -->
  <div class="controls">
    <button id="genBtn">Generate New Crisis Scenario</button>
    <button onclick="window.location.href='index.html'">Back to Home</button>
  </div>

<script>
/* ================================
   GAME STATE
================================ */
const DEPARTMENTS = [
  "CEO/SVPs","IT/Security","HR",
  "Finance","Loans","Accounting","Deposits"
];

const state = {
  scenario: null,
  index: 0,
  answered: false,
  scores: {}
};

DEPARTMENTS.forEach(d => state.scores[d] = 0);

/* ================================
   HELPERS
================================ */
const $ = id => document.getElementById(id);

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])
  );
}

// Fisher‚ÄìYates shuffle to randomize choice order each render
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ================================
   SCOREBOARD
================================ */
function renderScoreboard() {
  const colors = {
    "CEO/SVPs":"#8e44ad","IT/Security":"#c0392b","HR":"#2980b9",
    "Finance":"#27ae60","Loans":"#f39c12","Accounting":"#9b59b6","Deposits":"#2ecc71"
  };

  $("scoreboard").innerHTML = DEPARTMENTS.map(d => `
    <div class="department" style="background:${colors[d]}">
      ${d}
      <div class="score" id="score-${d}">${state.scores[d]}</div>
    </div>
  `).join("");
}

/* ================================
   LOAD SCENARIO
================================ */
async function loadScenario() {
  $("scenarioText").textContent = "Loading scenario...";
  $("questionBox").innerHTML = `<div class="loader"><div class="spinner"></div></div>`;

  const res = await fetch("/api/scenarios", { method: "POST" });
  const scenario = await res.json();

  state.scenario = scenario;
  state.index = 0;
  state.answered = false;
  DEPARTMENTS.forEach(d => state.scores[d] = 0);

  renderScoreboard();

  $("scenarioTitle").textContent = scenario.title;
  $("scenarioText").textContent = scenario.description;

  renderQuestion();
}

/* ================================
   RENDER QUESTION
================================ */
function renderQuestion() {
  const q = state.scenario.questions[state.index];
  state.answered = false;

  $("questionBox").innerHTML = `
    <div class="q-progress">
      Question ${state.index + 1} / ${state.scenario.questions.length}
    </div>

    <div class="question-card">
      <div class="department-label">${q.department}</div>
      <h2 class="question-title">${escapeHtml(q.questionText)}</h2>

      <div class="choices">
        ${shuffle(q.choices).map((c,i) => `
          <button class="choice-btn"
            data-score="${c.score}"
            data-reason="${escapeHtml(c.reason)}"
            onclick="pickAnswer(this,'${q.department}')">
            ${escapeHtml(c.text)}
          </button>
        `).join("")}
      </div>

      <div id="reasonBox" class="uc-box hidden"></div>

      <div class="next-button">
        <button id="nextBtn" class="hidden" onclick="nextQuestion()">Next Question</button>
      </div>
    </div>
  `;
}

/* ================================
   ANSWER HANDLING
================================ */
function pickAnswer(btn, dept) {
  if (state.answered) return;
  state.answered = true;

  document.querySelectorAll(".choice-btn").forEach(b => b.disabled = true);

  const score = Number(btn.dataset.score);
  const reason = btn.dataset.reason;

  if (score >= 10) btn.classList.add("correct");
  else if (score > 0) btn.classList.add("correct");
  else btn.classList.add("incorrect");

  state.scores[dept] += score;
  $(`score-${dept}`).textContent = state.scores[dept];

  const label = score >= 10 ? "Correct (+10)"
              : score > 0 ? "Partially Correct (+5)"
              : "Incorrect (-5)";

  const rb = $("reasonBox");
  rb.classList.remove("hidden");
  rb.innerHTML = `<h3>${label}</h3><p>${reason}</p>`;

  $("nextBtn").classList.remove("hidden");
}

/* ================================
   NEXT QUESTION
================================ */
function nextQuestion() {
  state.index++;
  if (state.index >= state.scenario.questions.length) {
    endGame();
  } else {
    renderQuestion();
  }
}

/* ================================
   END GAME
================================ */
function endGame() {
  const standings = Object.entries(state.scores).sort((a,b)=>b[1]-a[1]);
  const winner = standings[0];

  const rows = standings.map((s, i) => `
    <div class="result-row ${i===0 ? 'top' : ''}">
      <div class="result-left">
        <div class="rank">${i+1}</div>
        <div>
          <div class="dept-name">${s[0]}</div>
          <div class="dept-sub">Final score</div>
        </div>
      </div>
      <div class="result-score">${s[1]} pts</div>
    </div>
  `).join("");

  const qb = $("questionBox");
  qb.style.minHeight = "70vh";
  qb.style.position = "relative";
  qb.innerHTML = `
    <div class="winner-overlay">
      <div class="winner-card">
        <div class="winner-hero">
          <div class="trophy">üèÜ</div>
          <h1>Round Complete</h1>
          <p><strong>Winner:</strong> ${winner[0]} (${winner[1]} pts)</p>
        </div>
        <div class="winner-body">
          <div class="winner-pill"><span class="badge">1st</span> Congratulations, ${winner[0]}!</div>
          <div class="results-title">Final Standings</div>
          <div class="results-grid">${rows}</div>
          <div class="winner-actions">
            <button class="primary" onclick="loadScenario()">Play Again</button>
            <button class="secondary" onclick="window.location.href='index.html'">Back to Home</button>
          </div>
        </div>
      </div>
      <canvas id="confettiCanvas" class="confetti-canvas"></canvas>
    </div>
  `;

  launchConfetti(3000);
}

// Simple confetti animation
function launchConfetti(duration = 2000) {
  const canvas = document.getElementById('confettiCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const box = document.getElementById('questionBox');
  const rect = box.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;

  const colors = ['#ff6b6b','#feca57','#1dd1a1','#54a0ff','#5f27cd'];
  const particles = Array.from({ length: 160 }, () => ({
    x: Math.random()*canvas.width,
    y: -20 - Math.random()*100,
    vx: (Math.random()-0.5)*2,
    vy: 2 + Math.random()*3,
    size: 2 + Math.random()*4,
    rot: Math.random()*Math.PI,
    vr: (Math.random()-0.5)*0.2,
    color: colors[Math.floor(Math.random()*colors.length)]
  }));

  let start = null;
  function frame(ts) {
    if (!start) start = ts;
    const elapsed = ts - start;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      if (p.y > canvas.height + 20) {
        p.y = -20;
        p.x = Math.random()*canvas.width;
      }
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      // draw small rectangle confetti
      ctx.fillRect(-p.size, -p.size/2, p.size*2, p.size);
      ctx.restore();
    });

    if (elapsed < duration) {
      requestAnimationFrame(frame);
    } else {
      // fade out quickly
      let alpha = 1;
      const fade = () => {
        alpha -= 0.08;
        ctx.globalAlpha = Math.max(alpha, 0);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (alpha > 0) requestAnimationFrame(fade);
        else ctx.globalAlpha = 1;
      };
      requestAnimationFrame(fade);
    }
  }
  requestAnimationFrame(frame);
}

/* ================================
   BOOT
================================ */
document.getElementById("genBtn").addEventListener("click", loadScenario);
loadScenario();
</script>

</body>
</html>
