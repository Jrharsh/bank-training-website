<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis Management Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .back-button {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: #7f8c8d;
        }
        
        .department-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .department-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .department-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .department-score {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .scenario-reference {
            background: #ecf0f1;
            padding: 15px 15px 15px 15px; /* Added right padding for button */
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
            position: relative;
        }
        
        .scenario-toggle {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10; /* Ensure button stays on top */
        }
        
        .scenario-toggle:hover {
            background: #c0392b;
        }
        
        .scenario-content {
            margin-top: 10px;
            padding-right: 80px; /* Add space so text doesn't go under button */
        }
        
        .scenario-content.collapsed {
            display: none;
        }
        
        .scenario-title-area {
            padding-right: 80px; /* Add space for button */
            margin-bottom: 10px;
        }
        
        .scenario-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .scenario-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .scenario-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .option-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .option-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #e74c3c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-next {
            background: #27ae60;
            color: white;
        }
        
        .btn-next:hover {
            background: #229954;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .round-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #2c3e50;
        }
        
        .department-label {
            background: #3498db;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 20px;
            border: 3px solid #2980b9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ELEGANT STRIKES POPUP STYLES */
        .strikes-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .strikes-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .strikes-popup {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.5);
            transform: scale(0.7) translateY(30px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .strikes-overlay.show .strikes-popup {
            transform: scale(1) translateY(0);
        }

        .strikes-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #e74c3c);
            background-size: 200% 100%;
            animation: pulse-gradient 2s ease-in-out infinite;
        }

        @keyframes pulse-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .strikes-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: shake 0.6s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }

        .strikes-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .strikes-department {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .strikes-counter {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        .strike-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 3px solid;
        }

        .strike-indicator.active {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
            animation: strike-pulse 0.6s ease-out;
        }

        .strike-indicator.inactive {
            background: linear-gradient(145deg, #ecf0f1, #d5dbdb);
            color: #95a5a6;
            border-color: #bdc3c7;
        }

        @keyframes strike-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); }
        }

        .strikes-message {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }

        .strikes-warning {
            font-size: 1rem;
            color: #e67e22;
            font-weight: 600;
            margin-bottom: 25px;
            padding: 10px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .strikes-close-btn {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .strikes-close-btn:hover {
            background: linear-gradient(145deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .strikes-close-btn:active {
            transform: translateY(0);
        }

        /* Department Eliminated Popup Styles */
        .department-eliminated-popup {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            color: white;
            max-width: 600px;
        }

        .department-eliminated-popup::before {
            background: linear-gradient(90deg, #e74c3c, #8e44ad, #e74c3c);
        }

        .eliminated-image-container {
            margin-bottom: 20px;
            position: relative;
        }

        .eliminated-image {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: elimination-shake 1s ease-in-out;
        }

        @keyframes elimination-shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }

        .eliminated-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .department-eliminated-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: elimination-pulse 1s ease-in-out infinite;
        }

        @keyframes elimination-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; filter: brightness(1.2); }
        }

        .department-eliminated-title {
            font-size: 2rem;
            color: #e74c3c;
            margin-bottom: 15px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .department-eliminated-message {
            background: rgba(231, 76, 60, 0.2);
            color: #ecf0f1;
            border-color: #e74c3c;
            margin-bottom: 20px;
        }

        .continue-game-message {
            background: rgba(46, 204, 113, 0.2);
            color: #ecf0f1;
            border-color: #27ae60;
            border-left: 4px solid #27ae60;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .scenario-content {
                padding-right: 60px; /* Less padding on mobile */
            }
            
            .scenario-title-area {
                padding-right: 60px;
            }
            
            .scenario-toggle {
                padding: 4px 8px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="goHome()">← Back to Home</button>
        
        <div class="header">
            <h1>🏦 Crisis Management Game</h1>
            <p style="color: green; font-size: 20px;">✅ 21 Questions Per Scenario - All Departments</p>
            <p>Navigate realistic business scenarios and manage departmental impact</p>
        </div>
        
        <div class="round-info">
            <strong>Round: <span id="roundNumber">1</span></strong>
        </div>
        
        <div class="department-scores" id="departmentScores">
            <!-- Department cards will be populated by JavaScript -->
        </div>
        
        <!-- Always visible scenario reference -->
        <div id="scenarioReference" class="scenario-reference hidden">
            <button class="scenario-toggle" onclick="toggleScenario()">
                <span id="toggleText">Hide Scenario</span>
            </button>
            <div class="scenario-title-area">
                <div style="font-weight: bold; color: #e74c3c; margin-bottom: 10px;">
                    🚨 CRISIS SCENARIO: <span id="scenarioTitleRef"></span>
                </div>
            </div>
            <div id="scenarioContentRef" class="scenario-content">
                <!-- Scenario description will be shown here -->
            </div>
        </div>
        
        <div id="scenarioPanel" class="scenario-panel hidden">
            <div id="departmentLabel" class="department-label"></div>
            <div class="scenario-description" id="scenarioDescription"></div>
            <div class="options" id="optionsContainer"></div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-next" id="nextQuestionBtn" style="display: none;">Next Question</button>
            </div>
        </div>
        
        <div id="loadingPanel" class="loading hidden">
            Generating scenario... 🤖
        </div>
        
        <div id="messagePanel" class="hidden"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="generateBtn">Generate New Crisis</button>
            <button class="btn btn-secondary" id="resetBtn">Reset Game</button>
        </div>
    </div>

    <!-- ELEGANT STRIKES POPUP -->
    <div id="strikesOverlay" class="strikes-overlay">
        <div id="strikesPopup" class="strikes-popup">
            <div id="strikesIcon" class="strikes-icon">❌</div>
            <div id="strikesTitle" class="strikes-title">Critical Error!</div>
            <div id="strikesDepartment" class="strikes-department"></div>
            
            <div class="strikes-counter" id="strikesCounter">
                <!-- Strike indicators will be populated by JavaScript -->
            </div>
            
            <div id="strikesMessage" class="strikes-message"></div>
            <div id="strikesWarning" class="strikes-warning"></div>
            
            <button class="strikes-close-btn" onclick="closeStrikesPopup()">Continue Game</button>
        </div>
    </div>

    <script>
        console.log('Crisis Management Game Loaded');
        
        // Game State
        const departments = {
            'CEO_SVPs': { name: 'CEO/SVPs', score: 0, strikes: 0, color: '#8e44ad' },
            'IT_Security': { name: 'IT/Security', score: 0, strikes: 0, color: '#e74c3c' },
            'HR': { name: 'HR', score: 0, strikes: 0, color: '#3498db' },
            'Finance': { name: 'Finance', score: 0, strikes: 0, color: '#2ecc71' },
            'Loans': { name: 'Loans', score: 0, strikes: 0, color: '#f39c12' },
            'Accounting': { name: 'Accounting', score: 0, strikes: 0, color: '#9b59b6' },
            'Deposits': { name: 'Deposits', score: 0, strikes: 0, color: '#1abc9c' }
        };
        
        let currentRound = 1;
        let currentScenario = null;
        let currentQuestionIndex = 0;
        let scenarioCollapsed = false;
        
        // Navigation
        function goHome() {
            window.location.href = '/';
        }
        
        // Toggle scenario visibility
        function toggleScenario() {
            const content = document.getElementById('scenarioContentRef');
            const toggleText = document.getElementById('toggleText');
            
            scenarioCollapsed = !scenarioCollapsed;
            content.classList.toggle('collapsed', scenarioCollapsed);
            toggleText.textContent = scenarioCollapsed ? 'Show Scenario' : 'Hide Scenario';
        }

        // ELEGANT STRIKES POPUP FUNCTIONS
        function showStrikesPopup(departmentKey, strikeCount, isDepartmentEliminated = false) {
            const dept = departments[departmentKey];
            const overlay = document.getElementById('strikesOverlay');
            const popup = document.getElementById('strikesPopup');
            
            // Configure popup content
            if (isDepartmentEliminated) {
                // Add image container
                document.getElementById('strikesIcon').innerHTML = `
                    <div class="eliminated-image-container">
                        <img src="/images/eliminated.png" alt="Department Eliminated" class="eliminated-image" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="department-eliminated-icon" style="display: none;">💀</div>
                        <div class="eliminated-overlay">ELIMINATED</div>
                    </div>
                `;
                
                document.getElementById('strikesTitle').textContent = 'Department Eliminated!';
                document.getElementById('strikesDepartment').textContent = dept.name + ' Department';
                document.getElementById('strikesMessage').innerHTML = `
                    <strong>${dept.name}</strong> has made 3 critical errors and is no longer able to participate in crisis management decisions.
                `;
                document.getElementById('strikesWarning').innerHTML = `
                    <div class="continue-game-message">
                        🎮 The game continues with the remaining departments!<br>
                        Other departments must work harder to compensate.
                    </div>
                `;
                popup.classList.add('department-eliminated-popup');
                
                // Mark department as eliminated
                departments[departmentKey].eliminated = true;
                
                // Don't auto-reset, just show message for 3 seconds then close
                setTimeout(() => {
                    closeStrikesPopup();
                }, 3500);
            } else {
                document.getElementById('strikesIcon').textContent = '❌';
                document.getElementById('strikesTitle').textContent = 'Critical Error!';
                document.getElementById('strikesDepartment').textContent = dept.name + ' Department';
                document.getElementById('strikesMessage').textContent = 
                    `${dept.name} made a poor decision that could worsen the crisis. This decision has been recorded as a critical error.`;
                
                const remainingStrikes = 3 - strikeCount;
                document.getElementById('strikesWarning').textContent = 
                    remainingStrikes > 0 
                        ? `⚠️ ${remainingStrikes} more critical error(s) will eliminate this department!`
                        : '🚨 Next critical error will eliminate this department!';
                        
                popup.classList.remove('department-eliminated-popup');
            }
            
            // Update strikes counter visual
            updateStrikesCounter(strikeCount);
            
            // Show popup with animation
            overlay.classList.add('show');
        }

        function updateStrikesCounter(strikeCount) {
            const counter = document.getElementById('strikesCounter');
            counter.innerHTML = '';
            
            for (let i = 1; i <= 3; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'strike-indicator';
                
                if (i <= strikeCount) {
                    indicator.classList.add('active');
                    indicator.textContent = 'X';
                } else {
                    indicator.classList.add('inactive');
                    indicator.textContent = i;
                }
                
                counter.appendChild(indicator);
            }
        }

        function closeStrikesPopup() {
            const overlay = document.getElementById('strikesOverlay');
            overlay.classList.remove('show');
        }
        
        // Initialize the game
        function initGame() {
            console.log('Initializing game...');
            renderDepartmentScores();
            document.getElementById('roundNumber').textContent = currentRound;
        }
        
        // Render department score cards
        function renderDepartmentScores() {
            const container = document.getElementById('departmentScores');
            container.innerHTML = '';
            
            Object.entries(departments).forEach(([key, dept]) => {
                const card = document.createElement('div');
                card.className = 'department-card';
                card.style.borderLeftColor = dept.color;
                
                // Add visual indicator for strikes
                let strikeIndicator = '';
                for (let i = 0; i < 3; i++) {
                    if (i < dept.strikes) {
                        strikeIndicator += '❌';
                    } else {
                        strikeIndicator += '⚪';
                    }
                }
                
                // Check if department is eliminated
                if (dept.eliminated) {
                    card.style.opacity = '0.5';
                    card.style.background = '#f8f9fa';
                    card.innerHTML = `
                        <div class="department-name" style="color: #e74c3c;">💀 ${dept.name}</div>
                        <div class="department-score" style="color: #e74c3c; font-size: 1.2em;">ELIMINATED</div>
                        <div style="font-size: 0.8em; margin-top: 5px; color: #e74c3c;">3 Critical Errors</div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="department-name">${dept.name}</div>
                        <div class="department-score" style="color: ${dept.color}">${dept.score}</div>
                        <div style="font-size: 0.8em; margin-top: 5px;">${strikeIndicator}</div>
                    `;
                }
                
                container.appendChild(card);
            });
        }
        
        // Generate scenario
        async function generateScenario() {
            console.log('Generating new scenario...');
            showLoading(true);
            hideMessage();
            
            try {
                const response = await fetch('/api/generate-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }
                
                const scenario = await response.json();
                console.log('Scenario received:', scenario.questions.length, 'questions');
                
                currentScenario = scenario;
                currentQuestionIndex = 0;
                
                // Show the scenario reference
                document.getElementById('scenarioTitleRef').textContent = scenario.title;
                document.getElementById('scenarioContentRef').textContent = scenario.description;
                document.getElementById('scenarioReference').classList.remove('hidden');
                
                displayCurrentQuestion();
                
            } catch (error) {
                console.error('Error generating scenario:', error);
                showMessage(`Failed to generate scenario: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Display current question
        function displayCurrentQuestion() {
            if (!currentScenario || !currentScenario.questions) {
                showMessage('No scenario data available', 'error');
                return;
            }
            
            const question = currentScenario.questions[currentQuestionIndex];
            if (!question) {
                // Scenario complete
                currentRound++;
                document.getElementById('roundNumber').textContent = currentRound;
                document.getElementById('scenarioPanel').classList.add('hidden');
                document.getElementById('scenarioReference').classList.add('hidden');
                showMessage('🎉 Scenario Complete! All 21 questions answered. Generate a new crisis!', 'success');
                return;
            }
            
            // Check if the current department is eliminated - skip their questions
            if (departments[question.department] && departments[question.department].eliminated) {
                console.log(`Skipping question for eliminated department: ${question.department}`);
                currentQuestionIndex++;
                displayCurrentQuestion(); // Recursively call to get next question
                return;
            }
            
            console.log(`Displaying question ${currentQuestionIndex + 1}/21 for ${question.department}`);
            
            // Get department color
            const deptColor = departments[question.department]?.color || '#3498db';
            
            // Show department label
            const departmentLabel = document.getElementById('departmentLabel');
            departmentLabel.style.backgroundColor = deptColor;
            departmentLabel.style.borderColor = deptColor;
            departmentLabel.textContent = `🏢 ${question.department.replace('_', '/')} DEPARTMENT - QUESTION ${currentQuestionIndex + 1}/21`;
            
            // Show question text only (scenario is always visible above)
            document.getElementById('scenarioDescription').innerHTML = `
                <div style="font-weight: bold; color: #2c3e50; font-size: 1.2em;">
                    ${question.questionText}
                </div>
            `;
            
            // Show options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => selectOption(index, option);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('scenarioPanel').classList.remove('hidden');
        }
        
        // Handle option selection
        function selectOption(index, option) {
            console.log('Option selected:', index, option.text);
            
            // Get the current question to determine which department is answering
            const question = currentScenario.questions[currentQuestionIndex];
            const answeringDept = question.department;
            const impact = option.impacts[answeringDept] || 0;
            
            // Determine if this was a good, neutral, or bad choice
            let isGoodChoice = impact > 10;
            let isBadChoice = impact < -10;
            let isNeutralChoice = impact >= -10 && impact <= 10;
            
            console.log(`Impact for ${answeringDept}: ${impact}, Good: ${isGoodChoice}, Bad: ${isBadChoice}, Neutral: ${isNeutralChoice}`);
            
            // Disable all option buttons and show feedback
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === option.text) {
                    // Color the selected option based on its impact
                    if (isGoodChoice) {
                        btn.style.backgroundColor = '#27ae60'; // Green for good choice
                        btn.innerHTML = `${option.text} <strong style="color: white;">(+${impact} points - Good choice!)</strong>`;
                    } else if (isBadChoice) {
                        btn.style.backgroundColor = '#e74c3c'; // Red for bad choice
                        btn.innerHTML = `${option.text} <strong style="color: white;">(${impact} points - Poor choice!)</strong>`;
                    } else {
                        btn.style.backgroundColor = '#f39c12'; // Orange for neutral
                        btn.innerHTML = `${option.text} <strong style="color: white;">(${impact} points - Neutral)</strong>`;
                    }
                }
            });
            
            // Track strikes for bad choices
            let strikeAdded = false;
            
            // Apply score changes (only to answering department)
            Object.entries(option.impacts).forEach(([deptKey, impact]) => {
                if (departments[deptKey] && impact !== 0) {
                    departments[deptKey].score = Math.max(0, Math.min(200, departments[deptKey].score + impact));
                    
                    // Add strike for bad decisions (-15 or worse)
                    if (impact <= -15 && deptKey === answeringDept) {
                        departments[deptKey].strikes++;
                        strikeAdded = true;
                        console.log(`${departments[deptKey].name} received a strike! (${departments[deptKey].strikes}/3)`);
                        
                        // Check for department elimination
                        if (departments[deptKey].strikes >= 3) {
                            setTimeout(() => {
                                showStrikesPopup(deptKey, departments[deptKey].strikes, true);
                            }, 1000);
                            renderDepartmentScores();
                            return;
                        }
                    }
                }
            });
            
            renderDepartmentScores();
            
            // Show elegant strike notification
            if (strikeAdded) {
                setTimeout(() => {
                    showStrikesPopup(answeringDept, departments[answeringDept].strikes, false);
                }, 800);
            }
            
            // Show next button
            document.getElementById('nextQuestionBtn').style.display = 'block';
        }
        
        // Next question
        function nextQuestion() {
            currentQuestionIndex++;
            displayCurrentQuestion();
        }
        
        // Reset game
        function resetGame() {
            Object.keys(departments).forEach(key => {
                departments[key].score = 0;
                departments[key].strikes = 0;
                departments[key].eliminated = false; // Reset elimination status
            });
            currentRound = 1;
            currentScenario = null;
            currentQuestionIndex = 0;
            
            initGame();
            document.getElementById('scenarioPanel').classList.add('hidden');
            document.getElementById('scenarioReference').classList.add('hidden');
            hideMessage();
        }
        
        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingPanel').classList.toggle('hidden', !show);
        }
        
        function showMessage(message, type = 'error') {
            const panel = document.getElementById('messagePanel');
            panel.className = type;
            panel.textContent = message;
            panel.classList.remove('hidden');
        }
        
        function hideMessage() {
            document.getElementById('messagePanel').classList.add('hidden');
        }
        
        // Event listeners
        document.getElementById('generateBtn').addEventListener('click', generateScenario);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
        
        // Close popup when clicking outside of it
        document.getElementById('strikesOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStrikesPopup();
            }
        });
        
        // Initialize game
        initGame();
        console.log('Game ready!');
    </script>
</body>
</html>