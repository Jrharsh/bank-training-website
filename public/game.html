<script>
// Game State
const departments = {
    'CEO_SVPs': { name: 'CEO/SVPs', score: 0, strikes: 0, color: '#8e44ad' },
    'IT_Security': { name: 'IT/Security', score: 0, strikes: 0, color: '#e74c3c' },
    'HR': { name: 'HR', score: 0, strikes: 0, color: '#3498db' },
    'Finance': { name: 'Finance', score: 0, strikes: 0, color: '#2ecc71' },
    'Loans': { name: 'Loans', score: 0, strikes: 0, color: '#f39c12' },
    'Accounting': { name: 'Accounting', score: 0, strikes: 0, color: '#9b59b6' },
    'Deposits': { name: 'Deposits', score: 0, strikes: 0, color: '#1abc9c' }
};

let currentRound = 1;
let currentScenario = null;
let currentQuestionIndex = 0;
let scenarioCollapsed = false;

// Navigation
function goHome() {
    window.location.href = '/';
}

// Toggle scenario visibility
function toggleScenario() {
    const content = document.getElementById('scenarioContentRef');
    const toggleText = document.getElementById('toggleText');
    
    scenarioCollapsed = !scenarioCollapsed;
    content.classList.toggle('collapsed', scenarioCollapsed);
    toggleText.textContent = scenarioCollapsed ? 'Show Scenario' : 'Hide Scenario';
}

// ELEGANT STRIKES POPUP FUNCTIONS
function showStrikesPopup(departmentKey, strikeCount, isDepartmentEliminated = false) {
    const dept = departments[departmentKey];
    const overlay = document.getElementById('strikesOverlay');
    const popup = document.getElementById('strikesPopup');
    
    // Configure popup content
    if (isDepartmentEliminated) {
        document.getElementById('strikesIcon').innerHTML = `
            <div class="eliminated-image-container">
                <div class="department-eliminated-icon">üíÄ</div>
                <div class="eliminated-overlay">ELIMINATED</div>
            </div>
        `;
        
        document.getElementById('strikesTitle').textContent = 'Department Eliminated!';
        document.getElementById('strikesDepartment').textContent = dept.name + ' Department';
        document.getElementById('strikesMessage').innerHTML = `
            <strong>${dept.name}</strong> has made 3 critical errors and is no longer able to participate in crisis management decisions.
        `;
        document.getElementById('strikesWarning').innerHTML = `
            <div class="continue-game-message">
                üéÆ The game continues with the remaining departments!<br>
                Other departments must work harder to compensate.
            </div>
        `;
        popup.classList.add('department-eliminated-popup');
        
        // Mark department as eliminated
        departments[departmentKey].eliminated = true;
        
        // Show message for 3 seconds then close
        setTimeout(() => {
            closeStrikesPopup();
        }, 3500);
    } else {
        document.getElementById('strikesIcon').textContent = '‚ùå';
        document.getElementById('strikesTitle').textContent = 'Critical Error!';
        document.getElementById('strikesDepartment').textContent = dept.name + ' Department';
        document.getElementById('strikesMessage').textContent = 
            `${dept.name} made a poor decision that could worsen the crisis. This decision has been recorded as a critical error.`;
        
        const remainingStrikes = 3 - strikeCount;
        document.getElementById('strikesWarning').textContent = 
            remainingStrikes > 0 
                ? `‚ö†Ô∏è ${remainingStrikes} more critical error(s) will eliminate this department!`
                : 'üö® Next critical error will eliminate this department!';
                
        popup.classList.remove('department-eliminated-popup');
    }
    
    // Update strikes counter visual
    updateStrikesCounter(strikeCount);
    
    // Show popup with animation
    overlay.classList.add('show');
}

function updateStrikesCounter(strikeCount) {
    const counter = document.getElementById('strikesCounter');
    counter.innerHTML = '';
    
    for (let i = 1; i <= 3; i++) {
        const indicator = document.createElement('div');
        indicator.className = 'strike-indicator';
        
        if (i <= strikeCount) {
            indicator.classList.add('active');
            indicator.textContent = 'X';
        } else {
            indicator.classList.add('inactive');
            indicator.textContent = i;
        }
        
        counter.appendChild(indicator);
    }
}

function closeStrikesPopup() {
    const overlay = document.getElementById('strikesOverlay');
    overlay.classList.remove('show');
}

// Check if all departments are eliminated (Game Over)
function checkGameOver() {
    const activeDepartments = Object.values(departments).filter(dept => !dept.eliminated);
    if (activeDepartments.length === 0) {
        showGameOverPopup();
        return true;
    }
    return false;
}

function showGameOverPopup() {
    const overlay = document.getElementById('strikesOverlay');
    const popup = document.getElementById('strikesPopup');
    
    document.getElementById('strikesIcon').innerHTML = `üíÄ`;
    document.getElementById('strikesTitle').textContent = 'GAME OVER!';
    document.getElementById('strikesDepartment').textContent = 'All Departments Eliminated';
    document.getElementById('strikesMessage').innerHTML = `
        All departments have been eliminated due to critical errors. The bank has failed to manage the crisis effectively.
    `;
    document.getElementById('strikesWarning').innerHTML = `
        <div style="background: rgba(231, 76, 60, 0.2); color: #ecf0f1; border-color: #e74c3c; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: 600;">
            üîÑ Click "Reset Game" to start over with a new crisis scenario.
        </div>
    `;
    document.getElementById('strikesCounter').innerHTML = '';
    popup.classList.add('game-over-popup');
    
    overlay.classList.add('show');
}

// Initialize the game
function initGame() {
    renderDepartmentScores();
    document.getElementById('roundNumber').textContent = currentRound;
}

// Render department score cards
function renderDepartmentScores() {
    const container = document.getElementById('departmentScores');
    container.innerHTML = '';
    
    Object.entries(departments).forEach(([key, dept]) => {
        const card = document.createElement('div');
        card.className = 'department-card';
        card.style.borderLeftColor = dept.color;
        
        // Add visual indicator for strikes
        let strikeIndicator = '';
        for (let i = 0; i < 3; i++) {
            if (i < dept.strikes) {
                strikeIndicator += '‚ùå';
            } else {
                strikeIndicator += '‚ö™';
            }
        }
        
        // Check if department is eliminated
        if (dept.eliminated) {
            card.style.opacity = '0.5';
            card.style.background = '#f8f9fa';
            card.innerHTML = `
                <div class="department-name" style="color: #e74c3c;">üíÄ ${dept.name}</div>
                <div class="department-score" style="color: #e74c3c; font-size: 1.2em;">ELIMINATED</div>
                <div style="font-size: 0.8em; margin-top: 5px; color: #e74c3c;">3 Critical Errors</div>
            `;
        } else {
            card.innerHTML = `
                <div class="department-name">${dept.name}</div>
                <div class="department-score" style="color: ${dept.color || '#000'}">${dept.score}</div>
                <div style="font-size: 0.8em; margin-top: 5px;">${strikeIndicator}</div>
            `;
        }
        
        container.appendChild(card);
    });
}

// Generate scenario - IMPROVED LOCAL VERSION
function generateScenario() {
    showLoading(true);
    hideMessage();
    
    try {
        // Create scenario directly without API call
        currentScenario = createRandomScenario();
        currentQuestionIndex = 0;
        
        // Show the scenario reference
        document.getElementById('scenarioTitleRef').textContent = currentScenario.title;
        document.getElementById('scenarioContentRef').textContent = currentScenario.description;
        document.getElementById('scenarioReference').classList.remove('hidden');
        
        displayCurrentQuestion();
        
    } catch (error) {
        showMessage(`Failed to generate scenario: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

// Create scenarios directly in JavaScript - MUCH IMPROVED VERSION
function createRandomScenario() {
    const scenarioTemplates = [
        {
            type: 'cyberattack',
            title: 'Sophisticated Ransomware Attack Paralyzes Banking Operations',
            description: 'Hackers have deployed advanced ransomware across all banking systems, encrypting customer databases, transaction records, and core banking platforms. Online banking is completely offline, ATMs are non-functional, and branch computers display ransom demands for $3 million in cryptocurrency. The FBI cybercrime unit is en route. Customer calls are flooding in, and social media is buzzing with concerns about account safety.',
            icon: 'üîí'
        },
        {
            type: 'natural_disaster',
            title: 'Category 5 Hurricane Destroys Regional Banking Infrastructure',
            description: 'Hurricane Phoenix has made landfall as a Category 5 storm, forcing immediate evacuation of 15 branches across four states. Severe flooding has destroyed the main data center, backup generators have failed, and communication towers are down. An estimated 500,000 customers are affected, with no access to banking services. Local businesses cannot process payments, and emergency services need immediate financial coordination.',
            icon: 'üå™Ô∏è'
        },
        {
            type: 'disgruntled_employee',
            title: 'Terminated IT Administrator Launches Internal Sabotage Campaign',
            description: 'A recently fired senior IT administrator has used backdoor access to delete critical databases, leak confidential customer information on social media, and plant malicious code in banking systems. Internal emails containing sensitive merger discussions have been posted online. The employee is making public accusations of illegal lending practices, and local news stations are requesting interviews.',
            icon: 'üò°'
        },
        {
            type: 'regulatory_crisis',
            title: 'Federal Agents Execute Search Warrants for Money Laundering Investigation',
            description: 'FBI and Treasury agents have arrived with federal search warrants, seizing computers and financial records related to suspected money laundering activities. A major corporate client is alleged to have funneled $50 million in illicit funds through the bank. Federal regulators are threatening to freeze assets, and the bank\'s stock has dropped 18% in pre-market trading.',
            icon: '‚öñÔ∏è'
        },
        {
            type: 'economic_collapse',
            title: 'Regional Economic Meltdown Following Major Industry Collapse',
            description: 'The collapse of three major manufacturing companies has triggered massive unemployment, with jobless rates jumping from 3.8% to 14.2% in two weeks. Loan defaults are spiking at 400% above normal rates, commercial real estate values have dropped 25%, and panicked customers are attempting to withdraw life savings. Small businesses are defaulting on loans while requesting emergency credit.',
            icon: 'üìâ'
        },
        {
            type: 'workplace_violence',
            title: 'Armed Individual Takes Hostages at Main Branch Location',
            description: 'A former customer whose business loan was recently foreclosed has entered the main branch with weapons, taking employees and customers hostage. SWAT teams have surrounded the building, and the incident is being broadcast live on all local news channels. The individual is demanding to speak with senior executives and threatening harm if their demands are not met.',
            icon: 'üö®'
        },
        {
            type: 'pandemic_response',
            title: 'Emergency Health Orders Force Immediate Banking Restrictions',
            description: 'A new highly contagious virus variant has led to government-mandated closure of all indoor banking facilities. 75% of staff must quarantine immediately, branches can only operate drive-through services, and digital banking systems are experiencing 500% increased usage and frequent crashes. Customers need loan deferrals and emergency access to funds.',
            icon: 'üò∑'
        },
        {
            type: 'data_breach',
            title: 'Massive Data Breach Exposes 300,000 Customer Records',
            description: 'Cybercriminals have infiltrated the customer database through a third-party vendor, accessing Social Security numbers, account details, and transaction histories for 300,000 customers. Fraudulent transactions are being reported across multiple states, identity theft reports are surging, and regulatory authorities require immediate notification. Credit monitoring services are overwhelmed.',
            icon: 'üï≥Ô∏è'
        }
    ];
    
    // Randomly select a scenario type
    const selectedTemplate = scenarioTemplates[Math.floor(Math.random() * scenarioTemplates.length)];
    
    // Create questions for all departments with RIGHT/WRONG answers only
    const questions = createDepartmentQuestions(selectedTemplate);
    
    return {
        title: selectedTemplate.title,
        description: selectedTemplate.description,
        type: selectedTemplate.type,
        icon: selectedTemplate.icon,
        questions: shuffleArray(questions) // Randomize question order
    };
}

function createDepartmentQuestions(scenario) {
    const departments = ['CEO_SVPs', 'IT_Security', 'HR', 'Finance', 'Loans', 'Accounting', 'Deposits'];
    const questions = [];
    
    // Create 3 questions per department (21 total) - all scenario-specific
    departments.forEach(dept => {
        const deptQuestions = generateScenarioSpecificQuestions(dept, scenario);
        questions.push(...deptQuestions);
    });
    
    return questions;
}

function generateScenarioSpecificQuestions(department, scenario) {
    const questionSets = {
        'cyberattack': {
            'CEO_SVPs': [
                {
                    questionText: 'How should the CEO communicate this cyberattack to the public?',
                    options: [
                        { text: 'Issue immediate transparent statement acknowledging the attack and customer protection measures', impacts: { 'CEO_SVPs': 24 } },
                        { text: 'Minimize the incident and claim systems are functioning normally', impacts: { 'CEO_SVPs': -23 } }
                    ]
                },
                {
                    questionText: 'What is the CEO\'s priority during this cyber crisis?',
                    options: [
                        { text: 'Coordinate with law enforcement and activate emergency protocols immediately', impacts: { 'CEO_SVPs': 22 } },
                        { text: 'Focus on negotiating with hackers to minimize ransom payment', impacts: { 'CEO_SVPs': -25 } }
                    ]
                },
                {
                    questionText: 'How should leadership handle stakeholder concerns?',
                    options: [
                        { text: 'Schedule emergency board meeting and provide hourly updates to regulators', impacts: { 'CEO_SVPs': 23 } },
                        { text: 'Wait until the situation is resolved before contacting stakeholders', impacts: { 'CEO_SVPs': -24 } }
                    ]
                }
            ],
            'IT_Security': [
                {
                    questionText: 'What is the immediate response to the ransomware attack?',
                    options: [
                        { text: 'Immediately isolate all affected systems and activate offline backup protocols', impacts: { 'IT_Security': 25 } },
                        { text: 'Keep systems running while attempting to remove the ransomware', impacts: { 'IT_Security': -24 } }
                    ]
                },
                {
                    questionText: 'How should IT prioritize system recovery?',
                    options: [
                        { text: 'Restore core banking systems first using clean backups, then customer services', impacts: { 'IT_Security': 23 } },
                        { text: 'Try to decrypt files in place to restore all systems simultaneously', impacts: { 'IT_Security': -22 } }
                    ]
                },
                {
                    questionText: 'What security measures should be implemented during recovery?',
                    options: [
                        { text: 'Implement enhanced monitoring, change all credentials, and scan all systems', impacts: { 'IT_Security': 24 } },
                        { text: 'Focus on speed of recovery and worry about security improvements later', impacts: { 'IT_Security': -25 } }
                    ]
                }
            ],
            'HR': [
                {
                    questionText: 'How should HR manage employee communications during the cyberattack?',
                    options: [
                        { text: 'Hold emergency all-hands meeting to explain situation and provide clear instructions', impacts: { 'HR': 23 } },
                        { text: 'Limit communication to avoid causing panic among employees', impacts: { 'HR': -21 } }
                    ]
                },
                {
                    questionText: 'What staffing adjustments are needed during the cyber crisis?',
                    options: [
                        { text: 'Deploy emergency staffing plan with manual processes and extended hours', impacts: { 'HR': 22 } },
                        { text: 'Send non-essential employees home until systems are restored', impacts: { 'HR': -23 } }
                    ]
                },
                {
                    questionText: 'How should HR handle employee stress during the crisis?',
                    options: [
                        { text: 'Provide immediate stress support resources and flexible scheduling', impacts: { 'HR': 24 } },
                        { text: 'Expect employees to handle the stress and focus on work duties', impacts: { 'HR': -25 } }
                    ]
                }
            ],
            'Finance': [
                {
                    questionText: 'How should Finance assess the impact of the cyberattack?',
                    options: [
                        { text: 'Immediately calculate direct costs, lost revenue, recovery expenses, and regulatory fines', impacts: { 'Finance': 25 } },
                        { text: 'Wait until systems are restored to assess financial impact', impacts: { 'Finance': -22 } }
                    ]
                },
                {
                    questionText: 'What is Finance\'s approach to crisis-related expenses?',
                    options: [
                        { text: 'Pre-approve emergency spending for recovery efforts and customer protection', impacts: { 'Finance': 23 } },
                        { text: 'Require standard approval processes for all crisis-related expenses', impacts: { 'Finance': -24 } }
                    ]
                },
                {
                    questionText: 'How should Finance handle insurance and liability issues?',
                    options: [
                        { text: 'Immediately contact cyber insurance carriers and begin claims documentation', impacts: { 'Finance': 24 } },
                        { text: 'Handle all costs internally to avoid insurance complications', impacts: { 'Finance': -23 } }
                    ]
                }
            ],
            'Loans': [
                {
                    questionText: 'How should Loans department handle operations during the cyberattack?',
                    options: [
                        { text: 'Implement manual loan processing and emergency customer assistance programs', impacts: { 'Loans': 24 } },
                        { text: 'Suspend all loan operations until systems are fully restored', impacts: { 'Loans': -23 } }
                    ]
                },
                {
                    questionText: 'What is the approach to customer loan concerns during the crisis?',
                    options: [
                        { text: 'Proactively offer payment deferrals and establish emergency contact procedures', impacts: { 'Loans': 22 } },
                        { text: 'Tell customers to wait until systems are restored for any assistance', impacts: { 'Loans': -25 } }
                    ]
                },
                {
                    questionText: 'How should Loans assess portfolio risk during the cyber crisis?',
                    options: [
                        { text: 'Conduct immediate manual review of high-risk accounts and exposures', impacts: { 'Loans': 23 } },
                        { text: 'Assume all data is compromised and stop all risk assessments', impacts: { 'Loans': -24 } }
                    ]
                }
            ],
            'Accounting': [
                {
                    questionText: 'How should Accounting maintain records during the system outage?',
                    options: [
                        { text: 'Immediately implement comprehensive manual recording and backup procedures', impacts: { 'Accounting': 25 } },
                        { text: 'Wait for systems to be restored before processing any transactions', impacts: { 'Accounting': -24 } }
                    ]
                },
                {
                    questionText: 'What procedures should be implemented for transaction processing?',
                    options: [
                        { text: 'Establish secure manual processes with dual controls and verification', impacts: { 'Accounting': 23 } },
                        { text: 'Stop all transaction processing until computer systems are available', impacts: { 'Accounting': -25 } }
                    ]
                },
                {
                    questionText: 'How should Accounting handle regulatory reporting during the crisis?',
                    options: [
                        { text: 'Immediately notify regulators of the situation and prepare manual reports', impacts: { 'Accounting': 24 } },
                        { text: 'Wait until systems are restored to address any reporting requirements', impacts: { 'Accounting': -23 } }
                    ]
                }
            ],
            'Deposits': [
                {
                    questionText: 'How should Deposits reassure customers about their account safety?',
                    options: [
                        { text: 'Issue immediate public statement emphasizing FDIC protection and security measures', impacts: { 'Deposits': 25 } },
                        { text: 'Avoid public statements until the extent of the breach is known', impacts: { 'Deposits': -22 } }
                    ]
                },
                {
                    questionText: 'What alternative service methods should Deposits implement?',
                    options: [
                        { text: 'Deploy mobile banking units, extend branch hours, and implement manual processes', impacts: { 'Deposits': 24 } },
                        { text: 'Direct customers to wait until online systems are restored', impacts: { 'Deposits': -25 } }
                    ]
                },
                {
                    questionText: 'How should Deposits prevent customer panic during the cyber crisis?',
                    options: [
                        { text: 'Increase staffing, ensure adequate cash availability, and provide regular updates', impacts: { 'Deposits': 23 } },
                        { text: 'Implement withdrawal limits to prevent runs on the bank', impacts: { 'Deposits': -24 } }
                    ]
                }
            ]
        }
    };

    // Get questions for this department and scenario type
    let deptQuestions = questionSets[scenario.type]?.[department];
    
    // If no specific questions, use generic crisis questions
    if (!deptQuestions) {
        deptQuestions = generateGenericQuestions(department, scenario);
    }
    
    return deptQuestions.map((q, index) => ({
        questionNumber: index + 1,
        department: department,
        questionText: q.questionText,
        options: q.options
    }));
}

function generateGenericQuestions(department, scenario) {
    // Generic fallback questions when scenario-specific ones aren't defined
    return [
        {
            questionText: `How should ${department.replace('_', '/')} respond to this crisis situation?`,
            options: [
                { text: 'Implement emergency procedures and coordinate with other departments immediately', impacts: { [department]: 22 } },
                { text: 'Continue normal operations and wait for the crisis to resolve itself', impacts: { [department]: -23 } }
            ]
        },
        {
            questionText: `What resources should ${department.replace('_', '/')} prioritize during this crisis?`,
            options: [
                { text: 'Focus all available resources on crisis response and customer protection', impacts: { [department]: 24 } },
                { text: 'Maintain normal resource allocation and avoid disrupting routine operations', impacts: { [department]: -22 } }
            ]
        },
        {
            questionText: `How should ${department.replace('_', '/')} communicate during this crisis?`,
            options: [
                { text: 'Provide frequent, transparent updates to all stakeholders about the situation', impacts: { [department]: 23 } },
                { text: 'Limit communication to avoid causing panic and wait for the crisis to end', impacts: { [department]: -25 } }
            ]
        }
    ];
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Display current question
function displayCurrentQuestion() {
    if (!currentScenario || !currentScenario.questions) {
        showMessage('No scenario data available', 'error');
        return;
    }
    
    const question = currentScenario.questions[currentQuestionIndex];
    if (!question) {
        // Scenario complete
        currentRound++;
        document.getElementById('roundNumber').textContent = currentRound;
        document.getElementById('scenarioPanel').classList.add('hidden');
        document.getElementById('scenarioReference').classList.add('hidden');
        showMessage('üéâ Scenario Complete! All 21 questions answered. Generate a new crisis!', 'success');
        return;
    }
    
    // Check if the current department is eliminated - skip their questions
    if (departments[question.department] && departments[question.department].eliminated) {
        currentQuestionIndex++;
        displayCurrentQuestion(); // Recursively call to get next question
        return;
    }
    
    // Get department color
    const deptColor = departments[question.department]?.color || '#3498db';
    
    // Show department label
    const departmentLabel = document.getElementById('departmentLabel');
    departmentLabel.style.backgroundColor = deptColor;
    departmentLabel.style.borderColor = deptColor;
    departmentLabel.textContent = `üè¢ ${question.department.replace('_', '/')} DEPARTMENT - QUESTION ${currentQuestionIndex + 1}/21`;
    
    // Show question text only (scenario is always visible above)
    document.getElementById('scenarioDescription').innerHTML = `
        <div style="font-weight: bold; color: #2c3e50; font-size: 1.2em;">
            ${question.questionText}
        </div>
    `;
    
    // Show options (exactly 2 now - RIGHT and WRONG)
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'option-button';
        button.textContent = option.text;
        button.onclick = () => selectOption(index, option);
        optionsContainer.appendChild(button);
    });
    
    document.getElementById('nextQuestionBtn').style.display = 'none';
    document.getElementById('scenarioPanel').classList.remove('hidden');
}

// Handle option selection
function selectOption(index, option) {
    // Get the current question to determine which department is answering
    const question = currentScenario.questions[currentQuestionIndex];
    const answeringDept = question.department;
    const impact = option.impacts[answeringDept] || 0;
    
    // Determine if this was a right or wrong choice
    let isRightChoice = impact > 0;
    let isWrongChoice = impact < 0;
    
    // Disable all option buttons and show feedback
    const buttons = document.querySelectorAll('.option-button');
    buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === option.text) {
            // Color the selected option based on its impact
            if (isRightChoice) {
                btn.style.backgroundColor = '#27ae60'; // Green for right choice
                btn.innerHTML = `${option.text} <strong style="color: white;">(+${impact} points - Correct!)</strong>`;
            } else if (isWrongChoice) {
                btn.style.backgroundColor = '#e74c3c'; // Red for wrong choice
                btn.innerHTML = `${option.text} <strong style="color: white;">(${impact} points - Wrong!)</strong>`;
            }
        }
    });
    
    // Track strikes for wrong choices
    let strikeAdded = false;
    
    // Apply score changes (only to answering department)
    Object.entries(option.impacts).forEach(([deptKey, impact]) => {
        if (departments[deptKey] && impact !== 0) {
            departments[deptKey].score = Math.max(0, Math.min(200, departments[deptKey].score + impact));
            
            // Add strike for wrong decisions (negative impact)
            if (impact < 0 && deptKey === answeringDept) {
                departments[deptKey].strikes++;
                strikeAdded = true;
                
                // Check for department elimination
                if (departments[deptKey].strikes >= 3) {
                    setTimeout(() => {
                        showStrikesPopup(deptKey, departments[deptKey].strikes, true);
                        // Check if game is over after elimination
                        setTimeout(() => {
                            checkGameOver();
                        }, 4000);
                    }, 1000);
                    renderDepartmentScores();
                    return;
                }
            }
        }
    });
    
    renderDepartmentScores();
    
    // Show elegant strike notification
    if (strikeAdded) {
        setTimeout(() => {
            showStrikesPopup(answeringDept, departments[answeringDept].strikes, false);
        }, 800);
    }
    
    // Show next button
    document.getElementById('nextQuestionBtn').style.display = 'block';
}

// Next question
function nextQuestion() {
    currentQuestionIndex++;
    displayCurrentQuestion();
}

// Reset game
function resetGame() {
    Object.keys(departments).forEach(key => {
        departments[key].score = 0;
        departments[key].strikes = 0;
        departments[key].eliminated = false; // Reset elimination status
    });
    currentRound = 1;
    currentScenario = null;
    currentQuestionIndex = 0;
    
    initGame();
    document.getElementById('scenarioPanel').classList.add('hidden');
    document.getElementById('scenarioReference').classList.add('hidden');
    hideMessage();
    closeStrikesPopup(); // Close any open popups
}

// Utility functions
function showLoading(show) {
    document.getElementById('loadingPanel').classList.toggle('hidden', !show);
}

function showMessage(message, type = 'error') {
    const panel = document.getElementById('messagePanel');
    panel.className = type;
    panel.textContent = message;
    panel.classList.remove('hidden');
}

function hideMessage() {
    document.getElementById('messagePanel').classList.add('hidden');
}

// Event listeners
document.getElementById('generateBtn').addEventListener('click', generateScenario);
document.getElementById('resetBtn').addEventListener('click', resetGame);
document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);

// Close popup when clicking outside of it
document.getElementById('strikesOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStrikesPopup();
    }
});

// Initialize game
initGame();