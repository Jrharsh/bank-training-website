<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crisis Management Game</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <img src="/images/bank-logo.png" alt="SSBTX Logo">
    <div class="title">
      Crisis Management Game
      <span style="font-size:12px;background:#d3f9d8;color:#2b8a3e;padding:2px 6px;border-radius:6px;margin-left:8px;">
        Live
      </span>
    </div>
  </div>

  <!-- SCOREBOARD (ALWAYS VISIBLE) -->
  <div id="scoreboard" class="scoreboard"></div>

  <!-- SCENARIO -->
  <div class="scenario-box">
    <h2 id="scenarioTitle">Scenario</h2>
    <p id="scenarioText">Loading scenario...</p>
  </div>

  <!-- QUESTION AREA -->
  <div id="questionBox" class="question-box"></div>

  <!-- CONTROLS -->
  <div class="controls">
    <button id="genBtn">Generate New Crisis Scenario</button>
    <button onclick="window.location.href='index.html'">Back to Home</button>
  </div>

<script>
/* ================================
   GAME STATE
================================ */
const DEPARTMENTS = [
  "CEO/SVPs","IT/Security","HR",
  "Finance","Loans","Accounting","Deposits"
];

const state = {
  scenario: null,
  index: 0,
  answered: false,
  scores: {}
};

DEPARTMENTS.forEach(d => state.scores[d] = 0);

/* ================================
   HELPERS
================================ */
const $ = id => document.getElementById(id);

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])
  );
}

/* ================================
   SCOREBOARD
================================ */
function renderScoreboard() {
  const colors = {
    "CEO/SVPs":"#8e44ad","IT/Security":"#c0392b","HR":"#2980b9",
    "Finance":"#27ae60","Loans":"#f39c12","Accounting":"#9b59b6","Deposits":"#2ecc71"
  };

  $("scoreboard").innerHTML = DEPARTMENTS.map(d => `
    <div class="department" style="background:${colors[d]}">
      ${d}
      <div class="score" id="score-${d}">${state.scores[d]}</div>
    </div>
  `).join("");
}

/* ================================
   LOAD SCENARIO
================================ */
async function loadScenario() {
  $("scenarioText").textContent = "Loading scenario...";
  $("questionBox").innerHTML = `<div class="loader"><div class="spinner"></div></div>`;

  const res = await fetch("/api/scenarios", { method: "POST" });
  const scenario = await res.json();

  state.scenario = scenario;
  state.index = 0;
  state.answered = false;
  DEPARTMENTS.forEach(d => state.scores[d] = 0);

  renderScoreboard();

  $("scenarioTitle").textContent = scenario.title;
  $("scenarioText").textContent = scenario.description;

  renderQuestion();
}

/* ================================
   RENDER QUESTION
================================ */
function renderQuestion() {
  const q = state.scenario.questions[state.index];
  state.answered = false;

  $("questionBox").innerHTML = `
    <div class="q-progress">
      Question ${state.index + 1} / ${state.scenario.questions.length}
    </div>

    <div class="question-card">
      <div class="department-label">${q.department}</div>
      <h2 class="question-title">${escapeHtml(q.questionText)}</h2>

      <div class="choices">
        ${q.choices.map((c,i) => `
          <button class="choice-btn"
            data-score="${c.score}"
            data-reason="${escapeHtml(c.reason)}"
            onclick="pickAnswer(this,'${q.department}')">
            ${escapeHtml(c.text)}
          </button>
        `).join("")}
      </div>

      <div id="reasonBox" class="uc-box hidden"></div>

      <div class="next-button">
        <button id="nextBtn" class="hidden" onclick="nextQuestion()">Next Question</button>
      </div>
    </div>
  `;
}

/* ================================
   ANSWER HANDLING
================================ */
function pickAnswer(btn, dept) {
  if (state.answered) return;
  state.answered = true;

  document.querySelectorAll(".choice-btn").forEach(b => b.disabled = true);

  const score = Number(btn.dataset.score);
  const reason = btn.dataset.reason;

  if (score >= 10) btn.classList.add("correct");
  else if (score > 0) btn.classList.add("correct");
  else btn.classList.add("incorrect");

  state.scores[dept] += score;
  $(`score-${dept}`).textContent = state.scores[dept];

  const label = score >= 10 ? "Correct (+10)"
              : score > 0 ? "Partially Correct (+5)"
              : "Incorrect (-5)";

  const rb = $("reasonBox");
  rb.classList.remove("hidden");
  rb.innerHTML = `<h3>${label}</h3><p>${reason}</p>`;

  $("nextBtn").classList.remove("hidden");
}

/* ================================
   NEXT QUESTION
================================ */
function nextQuestion() {
  state.index++;
  if (state.index >= state.scenario.questions.length) {
    endGame();
  } else {
    renderQuestion();
  }
}

/* ================================
   END GAME
================================ */
function endGame() {
  const winner = Object.entries(state.scores).sort((a,b)=>b[1]-a[1])[0];

  $("questionBox").innerHTML = `
    <div class="winner-overlay">
      <h1>Round Complete</h1>
      <p><strong>Winner:</strong> ${winner[0]} (${winner[1]} pts)</p>
    </div>
  `;
}

/* ================================
   BOOT
================================ */
document.getElementById("genBtn").addEventListener("click", loadScenario);
loadScenario();
</script>

</body>
</html>
